name: Test Coverage Report

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  test-coverage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Set up Yarn v4 (Berry)
        run: |
          corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Run tests with coverage
        run: yarn unit:test:coverage
        env:
          NODE_ENV: test

      - name: Post coverage report to PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Read the text-summary coverage report
            const coverageText = fs.readFileSync('./coverage/coverage.txt', 'utf8');
            
            // Extract coverage percentages using regex
            const statementsMatch = coverageText.match(/Statements\s*:\s*(\d+\.\d+)%/);
            const branchesMatch = coverageText.match(/Branches\s*:\s*(\d+\.\d+)%/);
            const functionsMatch = coverageText.match(/Functions\s*:\s*(\d+\.\d+)%/);
            const linesMatch = coverageText.match(/Lines\s*:\s*(\d+\.\d+)%/);
            
            // Extract covered/total numbers
            const statementsDetails = coverageText.match(/Statements\s*:\s*(\d+\.\d+)%\s*\((\d+)\/(\d+)\)/);
            const branchesDetails = coverageText.match(/Branches\s*:\s*(\d+\.\d+)%\s*\((\d+)\/(\d+)\)/);
            const functionsDetails = coverageText.match(/Functions\s*:\s*(\d+\.\d+)%\s*\((\d+)\/(\d+)\)/);
            const linesDetails = coverageText.match(/Lines\s*:\s*(\d+\.\d+)%\s*\((\d+)\/(\d+)\)/);
            
            const coverageMessage = `
            ## Test Coverage Report
            
            | Category | Coverage |
            |----------|----------|
            | Statements | ${statementsMatch ? statementsMatch[1] : 'N/A'}% |
            | Branches | ${branchesMatch ? branchesMatch[1] : 'N/A'}% |
            | Functions | ${functionsMatch ? functionsMatch[1] : 'N/A'}% |
            | Lines | ${linesMatch ? linesMatch[1] : 'N/A'}% |
            
            ### Coverage Details
            - Statements: ${statementsDetails ? `${statementsDetails[2]}/${statementsDetails[3]}` : 'N/A'}
            - Branches: ${branchesDetails ? `${branchesDetails[2]}/${branchesDetails[3]}` : 'N/A'}
            - Functions: ${functionsDetails ? `${functionsDetails[2]}/${functionsDetails[3]}` : 'N/A'}
            - Lines: ${linesDetails ? `${linesDetails[2]}/${linesDetails[3]}` : 'N/A'}
            
            <details>
            <summary>Full Coverage Report</summary>
            
            \`\`\`
            ${coverageText}
            \`\`\`
            </details>
            `;
            
            // Find existing coverage comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const coverageComment = comments.find(comment => 
              comment.body.includes('## Test Coverage Report')
            );
            
            if (coverageComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: coverageComment.id,
                body: coverageMessage
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: coverageMessage
              });
            }
